name: CI - Build & Push Auth Service Image

on:
  push:
    branches:
      - master
      - develop
      - devops/*
    paths:
      - src/**
      - pom.xml
      - Dockerfile
      - .github/workflows/ci-auth-service.yml

  workflow_dispatch:

env:
  AWS_REGION: ap-south-1
  ECR_REPOSITORY: lms/auth-service

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin
          cache: maven

      - name: Checkout shared-lib
        uses: actions/checkout@v4
        with:
          repository: LaborManagement/shared-lib
          ref: rahulc_branch
          path: shared-lib
          token: ${{ secrets.PAT_TOKEN }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Compute image tag
        id: tag
        run: |
          BRANCH="${GITHUB_REF_NAME}"
          SHORT_SHA="${GITHUB_SHA::7}"
          DATE="$(date -u +%Y%m%d)"

          if [[ "$BRANCH" == "master" ]]; then
            TAG="prod-${DATE}-${SHORT_SHA}"
          elif [[ "$BRANCH" == "develop" ]]; then
            TAG="dev-${DATE}-${SHORT_SHA}"
          else
            SAFE_BRANCH=$(echo "$BRANCH" | sed 's|/|-|g')
            TAG="${SAFE_BRANCH}-${DATE}-${SHORT_SHA}"
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ steps.ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.tag.outputs.tag }}
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.created=${{ github.run_id }}

      - name: Summary
        run: |
          echo "### Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ env.ECR_REPOSITORY }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
